<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Building Google Home Action in Go @ Alex Pliutau's Blog</title>
        <meta name="description" content="Google Home This is a text version of this video: packagemain #10: Building Google Home Action in Go.
Google Home is a voice Assistant, similar to Amazon Alexa, but working with Google services. It has a lot of built-in integrations, but what is interesting for us developes is that we can build our programs for it. Google call them Actions.
We will build an Action, which will help user to find an air quality index of the city user is located in.">
        <meta name="keywords" content="go, google-home, google-assistant, google-cloud-platform, alex pliutau, golang, go, programming, docker, swagger, git">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.52" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="Building Google Home Action in Go">
<meta property="og:description" content="Google Home This is a text version of this video: packagemain #10: Building Google Home Action in Go.
Google Home is a voice Assistant, similar to Amazon Alexa, but working with Google services. It has a lot of built-in integrations, but what is interesting for us developes is that we can build our programs for it. Google call them Actions.
We will build an Action, which will help user to find an air quality index of the city user is located in.">
<meta property="og:type" content="article">
<meta property="og:url" content="/building-google-home-action-in-go/">

<meta property="og:image" content="/grpc-json.png" />


        <link rel="stylesheet" href="/dist/styles.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        
		<link rel="shortcut icon" href="/favicon.ico">
		
			<script id="dsq-count-scr" src="//pliutau.disqus.com/count.js" async></script>
		
    </head>
    <body>
        
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-72731922-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/pliutau">
                                <i class="fa fa-twitter"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Youtube" title="Youtube" href="https://www.youtube.com/packagemain">
                                <i class="fa fa-youtube"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/plutov">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href="https://stackoverflow.com/users/350294/pltvs">
                                <i class="fa fa-stack-overflow"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="LinkedIn" title="LinkedIn" href="https://linkedin.com/in/pltvs/">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Email" title="Email" href="mailto:a.pliutau@gmail.com">
                                <i class="fa fa-envelope"></i>
                            </a>
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/page/about/">About</a>
    </li>

    <li class="site-nav-item">
        <a title="Hire Me" href="/page/hire-me/">Hire Me</a>
    </li>

    <li class="site-nav-item">
        <a title="Subscribe" href="https://eepurl.com/cDoD09">Subscribe</a>
    </li>

    <li class="site-nav-item">
        <a title="Buy me a coffee" href="https://www.buymeacoffee.com/packagemain">Buy me a coffee</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Building Google Home Action in Go</h1>
    
    <p class="post-date">
        <span>Published <time datetime="2018-04-02"  itemprop="datePublished">Mon, Apr 2, 2018</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="https://pliutau.com" itemprop="url" rel="author">Alex Pliutau</a>
            </span>
        </span>
    </p>
</header>
		<footer class="post-footer clearfix share-middle">
    <div class="share">
	<a class="icon-twitter" href="https://twitter.com/share?text=Building%20Google%20Home%20Action%20in%20Go&url=%2fbuilding-google-home-action-in-go%2f"
		onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
		<i class="fa fa-twitter"></i>
		<span class="hidden">Twitter</span>
	</a>

	<a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=%2fbuilding-google-home-action-in-go%2f"
		onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
		<i class="fa fa-facebook"></i>
		<span class="hidden">Facebook</span>
	</a>

	<a class="icon-google-plus" href="https://plus.google.com/share?url=%2fbuilding-google-home-action-in-go%2f"
	  onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
	  <i class="fa fa-google-plus"></i>
		<span class="hidden">Google+</span>
	</a>

	<a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&title=Building%20Google%20Home%20Action%20in%20Go&url=%2fbuilding-google-home-action-in-go%2f&summary="
	   onclick="window.open(this.href, 'linkedin-share', 'width=554,height=481');return false;">
	   <i class="fa fa-linkedin"></i>
	   <span class="hidden">LinkedIn</span>
	</a>
</div>

</footer>

		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:100%;height:90px;margin-top:20px;margin-bottom:20px;"
     data-ad-client="ca-pub-9796117147060610"
     data-ad-slot="8595828683"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

        <div class="post-content clearfix" itemprop="articleBody">
    

    

<p><img src="/GoogleHome1.jpg" alt="Building Google Home Action in Go" /></p>

<h3 id="google-home">Google Home</h3>

<p>This is a text version of this video: <a href="https://youtu.be/LeGuJo7QBbI">packagemain #10: Building Google Home Action in Go</a>.</p>

<p>Google Home is a voice Assistant, similar to Amazon Alexa, but working with Google services. It has a lot of built-in integrations, but what is interesting for us developes is that we can build our programs for it. Google call them Actions.</p>

<p>We will build an Action, which will help user to find an air quality index of the city user is located in. It&rsquo;s not necessary to have Google Home device to be able to build and test it, Google has very nice Similuator.</p>

<p>Google Home Actions are using DialogFlow (previously it called api.ai) to setup conversation flow using NLU. And we will build a simple backend API to get data, which we&rsquo;ll deploy to Google Cloud.</p>

<h3 id="dialogflow">Dialogflow</h3>

<p>We have to login with our Google Account to <a href="https://dialogflow.com">https://dialogflow.com</a>. Go to Console and create your first project. You can choose to use existing Google Cloud project or create a new one.</p>

<p>We will use DialogFlow API V1, V2 is slightly different in terms of request/response format.</p>

<p>Now let&rsquo;s decide the future user flow.</p>

<p>There are 2 ways to start to talk to our Action: explicit invocation and implicit invocation. Explicit one is triggered when we tell Google &ldquo;Talk to <action name>&rdquo;. In implicit invocation we can set up custom messages, but we will skip this option for our demo program. Basically you need to create an intent and describe possible sentences user may say.</p>

<p>We need to know user&rsquo;s location to get information, so first of all we need to ask for this permission. Google Action has functionality to ask for location permission. We need to send specific response to DialogFlow after user started to talk to Action.</p>

<p>Let&rsquo;s define it in welcome intent. We need to set the action name <code>location_permission</code> and then in our webhook we can check it. Also we need to <code>Enable webhook call for this intent</code>.</p>

<p>Let&rsquo;s describe our fallback intent with default fallback message. This intent will be executed when action doesn&rsquo;t understand what user wants.</p>

<p><code>Sorry, I can't help you with this right now. Please try later.</code>. Set intent as end of conversation.</p>

<p>Now let&rsquo;s define the main intent to get air quality. This intent will be triggered not by specific word but by reserved event: <code>actions_intent_PERMISSION</code>. So when user granted access to location info this intent will be executed. We set action name as <code>get</code> and will handle it later in API. Also we need to enable webhook call for this. And set end of conversation.</p>

<p>Ok, we&rsquo;re almost done with configuration, let&rsquo;s define how Google Action will get data.</p>

<p>Go to Fulfillment. There are 2 options to write a backend logic: using custom webhook or to use inline editor powered by cloud functions on Firebase, but it&rsquo;s node.js so we will go with first one and provide endpoint to API deployed to Google Cloud.</p>

<h3 id="api">API</h3>

<p>You should already have Google Cloud project and <code>gcloud</code> SDK installed, so we can write <code>app.yaml</code> file to describe handlers and runtime:</p>

<pre><code>runtime: go
api_version: go1

handlers:
- url: /
  script: _go_app
</code></pre>

<p>Dialogflow will send 2 different requests to 1 endpoint: 1 for <code>location_permission</code> and 2 to <code>get</code> results.</p>

<pre><code>package app

import (
	&quot;fmt&quot;
	&quot;net/http&quot;
)

func init() {
	http.HandleFunc(&quot;/&quot;, handle)
}

func handle(w http.ResponseWriter, r *http.Request) {
	dfReq := DialogFlowRequest{}
	dfErr := json.NewDecoder(r.Body).Decode(&amp;dfReq)

	if dfErr == nil &amp;&amp; dfReq.Result.Action == &quot;location_permission&quot; {
		handleLocationPermissionAction(w, r, dfReq)
		return
	}

	if dfErr == nil &amp;&amp; dfReq.Result.Action == &quot;get&quot; {
		handleGetAction(w, r, dfReq)
		return
	}

	json.NewEncoder(w).Encode(DialogFlowResponse{
		Speech: unknownErrMsg,
	})
}
</code></pre>

<h3 id="ask-for-location-permission">Ask for location permission</h3>

<p>In <code>handleLocationPermissionAction</code> we need to send back a specific response which will tell Dialogflow to ask for <code>DEVICE_PRECISE_LOCATION</code> permission. We set a question message telling user why we need location.</p>

<pre><code>func handleLocationPermissionAction(w http.ResponseWriter, r *http.Request, dfReq DialogFlowRequest) {
	json.NewEncoder(w).Encode(DialogFlowLocationResponse{
		Speech: &quot;PLACEHOLDER_FOR_PERMISSION&quot;,
		Data: DialogFlowResponseData{
			Google: DialogFlowResponseGoogle{
				ExpectUserResponse: true,
				IsSsml:             false,
				SystemIntent: DialogFlowResponseSystemIntent{
					Intent: &quot;actions.intent.PERMISSION&quot;,
					Data: DialogFlowResponseSystemIntentData{
						Type:        &quot;type.googleapis.com/google.actions.v2.PermissionValueSpec&quot;,
						OptContext:  &quot;To get city for air quality check&quot;,
						Permissions: []string{&quot;DEVICE_PRECISE_LOCATION&quot;},
					},
				},
			},
		},
	})
}
</code></pre>

<h3 id="get-results">Get results</h3>

<p>When user replies that it&rsquo;s ok to check location, dialogflow will send us coordinates in <code>get</code> action, so we can use it to check air quality index.</p>

<pre><code>func handleGetAction(w http.ResponseWriter, r *http.Request, dfReq DialogFlowRequest) {
	lat := dfReq.OriginalRequest.Data.Device.Location.Coordinates.Lat
	long := dfReq.OriginalRequest.Data.Device.Location.Coordinates.Long
	if lat == 0 || long == 0 {
		json.NewEncoder(w).Encode(DialogFlowResponse{
			Speech: unknownErrMsg,
		})
		return
	}

	index, levelDescription, aqiErr := getAirQualityByCoordinates(r, lat, long)
	if aqiErr != nil {
		json.NewEncoder(w).Encode(DialogFlowResponse{
			Speech: apiErrMsg,
		})
		return
	}

	json.NewEncoder(w).Encode(DialogFlowResponse{
		Speech: fmt.Sprintf(&quot;The air quality index in your city is %d right now. %s&quot;, index, levelDescription),
	})
}
</code></pre>

<p>Finally, let&rsquo;s deploy our app:</p>

<pre><code>gcloud app deploy
</code></pre>

<p>If everything is fine, this command will give us endpoint which we should add in Fulfillment section.</p>

<h3 id="test-it-with-simulator">Test it with Simulator</h3>

<p>And now it&rsquo;s time to try this nice Simulator I was talking about. Go to Integrations -&gt; Assistant, setup welcome intent and click Test.</p>

<p>Simulator works with keyboard input and also with voice input. Currently our Action is accessible only to us, to make it public, we need to submit it for verification.</p>

<p>Type <code>Talk to my test app</code>.
- Yes.
- Profit!</p>

<p>If your Google Home device is using same Google account, you we can test it there also.</p>

<p>I am going to send this application for Google review, as I find this air quality information really necessary for me as I&rsquo;m living in Asia.</p>

<p><a href="https://github.com/plutov/packagemain/tree/master/10-ghome-aqi">Full code of this program on GitHub</a></p>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/go/">go</a>
                , 
            
                <a href="/tags/google-home/">google-home</a>
                , 
            
                <a href="/tags/google-assistant/">google-assistant</a>
                , 
            
                <a href="/tags/google-cloud-platform/">google-cloud-platform</a>
                
            
        </p>
    

    <div class="share">
	<a class="icon-twitter" href="https://twitter.com/share?text=Building%20Google%20Home%20Action%20in%20Go&url=%2fbuilding-google-home-action-in-go%2f"
		onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
		<i class="fa fa-twitter"></i>
		<span class="hidden">Twitter</span>
	</a>

	<a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=%2fbuilding-google-home-action-in-go%2f"
		onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
		<i class="fa fa-facebook"></i>
		<span class="hidden">Facebook</span>
	</a>

	<a class="icon-google-plus" href="https://plus.google.com/share?url=%2fbuilding-google-home-action-in-go%2f"
	  onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
	  <i class="fa fa-google-plus"></i>
		<span class="hidden">Google+</span>
	</a>

	<a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&title=Building%20Google%20Home%20Action%20in%20Go&url=%2fbuilding-google-home-action-in-go%2f&summary="
	   onclick="window.open(this.href, 'linkedin-share', 'width=554,height=481');return false;">
	   <i class="fa fa-linkedin"></i>
	   <span class="hidden">LinkedIn</span>
	</a>
</div>

</footer>

		<link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
	#mc_embed_signup{
		width:100%;
		border: 1px solid #dddbcc;
		border-radius: 3px;
		margin: 20px 0;
		background: #f1f0ea;
	}
	#mc_embed_signup .button { background: #f03838 !important; }
</style>
<div id="mc_embed_signup">
<form action="//pliutau.us15.list-manage.com/subscribe/post?u=48e0bc513d92114dd04b36ffa&amp;id=862c25c5fb" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Get the latest posts delivered right to your inbox.</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_48e0bc513d92114dd04b36ffa_862c25c5fb" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

        
    <div class="comments">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "pliutau" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:100%;height:90px;margin-top:20px;margin-bottom:20px;"
     data-ad-client="ca-pub-9796117147060610"
     data-ad-slot="8595828683"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </article>
</div>

                </div>
        </div>

        <footer class="footer">
            <div class="container">
                <p class="footer-copyright site-title-wrapper">
                    <span>&copy; 2018 Alex Pliutau. All rights reserved.</span>
                </p>
            </div>
        </footer>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
		<script type="text/javascript">
			hljs.initHighlightingOnLoad();
		</script>
    </body>
</html>

